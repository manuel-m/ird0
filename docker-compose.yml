services:
  policyholders:
    build:
      context: .
      dockerfile: microservices/directory/Dockerfile
      args:
        APP_YML: policyholders.yml
    image: directory-policyholders
    ports:
      - "8081:8081"
    depends_on:
      - sftp-server
    environment:
      - SFTP_HOST=sftp-server
      - SFTP_PORT=2222
      - SFTP_USERNAME=policyholder-importer
      - SFTP_PRIVATE_KEY_PATH=/app/keys/sftp_client_key
    volumes:
      - ./keys:/app/keys:ro

  experts:
    build:
      context: .
      dockerfile: microservices/directory/Dockerfile
      args:
        APP_YML: experts.yml
    image: directory-experts
    ports:
      - "8082:8082"

  providers:
    build:
      context: .
      dockerfile: microservices/directory/Dockerfile
      args:
        APP_YML: providers.yml
    image: directory-providers
    ports:
      - "8083:8083"

  sftp-server:
    build:
      context: .
      dockerfile: microservices/sftp-server/Dockerfile
      args:
        APP_YML: sftp.yml
    image: sftp-server
    ports:
      - "2222:2222"  # SFTP port
      - "9090:9090"  # Management/actuator port
    environment:
      - SFTP_DATA_DIR=/app/data
      - SFTP_HOST_KEY_PATH=/app/keys/hostkey.pem
      - SFTP_AUTHORIZED_KEYS_PATH=/app/keys/authorized_keys
    volumes:
      - ./data:/app/data:ro  # Mount data directory as read-only
      - ./keys:/app/keys      # Mount keys directory for host key persistence
